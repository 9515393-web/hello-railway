<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    /* POPUP */
    .leaflet-popup-content-wrapper { border-radius: 14px; }
    .leaflet-popup-content {
      width: 420px !important;
      max-width: 420px !important;
      max-height: 60vh;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.4;
      white-space: normal !important;
      word-break: normal;
      overflow-wrap: break-word;
    }
    .popup-root { font-size: 16px; line-height: 1.4; }

    /* BUTTONS */
    .leaflet-control.custom-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.9);
      pointer-events: auto;
      z-index: 1000;
    }
    .leaflet-control.custom-buttons button {
      min-height: 48px;
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 12px;
      pointer-events: auto;
      cursor: pointer;
    }

    /* LABELS */
    .parcel-label{
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      color: #111 !important;
      font-weight: 700 !important;
      font-size: 12px !important;
      text-shadow: 0 0 2px #fff, 0 0 2px #fff;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    console.log("MAP SCRIPT LOADED");
    console.log("SCRIPT VERSION CLEAN CARD_FINAL ONLY v2026-02-17");

    (function () {
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");
      if (!token) { alert("‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞"); throw new Error("No token"); }

      const map = L.map("map", { zoomControl: false });
      setTimeout(() => map.invalidateSize(true), 0);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap"
      }).addTo(map);

      fetch(`Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(data => {
          let selected = null;

          // 1) –ü–æ–¥–ª–æ–∂–∫–∞: –≤—Å–µ –≥—Ä–∞–Ω–∏—Ü—ã (–ö–ü–¢ + –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ) ‚Äî –ö–†–ê–°–ù–´–ï
          const baseLayer = L.geoJSON(data, {
            interactive: false,
            style: { color: "#ff0000", weight: 1, opacity: 0.35, fill: false }
          }).addTo(map);

          // –ù–æ–º–µ—Ä –Ω–∞ –ø–ª–∞–Ω–µ –±–µ—Ä—ë–º –¢–û–õ–¨–ö–û –∏–∑ card_final:
          // - –∏—â–µ–º "—É—á. 278" / "—É—á 278" / "—É—á–∞—Å—Ç–æ–∫ 278" / "—É—á–∞—Å—Ç–æ–∫ ‚Ññ 278" / "‚Ññ 278"
          function extractNumberFromCard(card) {
            const raw = String(card || "");
            const m = raw.match(/(?:—É—á\.?|—É—á–∞—Å—Ç–æ–∫|‚Ññ)\s*‚Ññ?\s*(\d+)/i);
            return (m && m[1]) ? m[1] : "";
          }

          // 2) –£—á–∞—Å—Ç–∫–∏: –∫–∞—Ä—Ç–æ—á–∫–∞ –¢–û–õ–¨–ö–û card_final, –ø–æ–¥–ø–∏—Å—å –¢–û–õ–¨–ö–û –∏–∑ card_final
          const parcelsLayer = L.geoJSON(data, {
            style: { color: "#ff0000", weight: 2, fillOpacity: 0.20 },

            onEachFeature: (feature, layer) => {
              const p = feature.properties || {};

              // –ö–∞—Ä—Ç–æ—á–∫–∞ ‚Äî –¢–û–õ–¨–ö–û card_final
              const rawBody = String(p.card_final || "").trim();
              const bodyHtml = rawBody.replace(/\n/g, "<br>");

              const html = `
                <div class="popup-root">
                  <div>${bodyHtml}</div>
                </div>
              `;
              layer.bindPopup(html, { maxWidth: 9999, autoPan: true });

              // –ü–æ–¥–ø–∏—Å—å –Ω–æ–º–µ—Ä–∞ –Ω–∞ –ø–ª–∞–Ω–µ ‚Äî –¢–û–õ–¨–ö–û –∏–∑ card_final
              const num = extractNumberFromCard(rawBody);

              // –ó–∞–ø—Ä–µ—Ç: –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ù–ï –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º (–≤ —Ç.—á. –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è "47" –∏–∑ uch_num/–∫–∞–¥–∞—Å—Ç—Ä–∞)
              // –ò—Å–∫–ª—é—á–µ–Ω–∏–µ "47": –±—É–¥–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ "47" —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å –≤ card_final (—Ç–æ–≥–¥–∞ extractNumberFromCard –≤–µ—Ä–Ω—ë—Ç 47)
              if (num) {
                try {
                  if (layer.getBounds && layer.getBounds().isValid()) {
                    layer.bindTooltip(num, {
                      permanent: true,
                      direction: "center",
                      className: "parcel-label"
                    });
                  }
                } catch (e) {
                  // –º–æ–ª—á–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ –±–∏—Ç—ã–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
                }
              }

              layer.on("click", () => {
                if (selected && selected !== layer) {
                  selected.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.20 });
                }
                selected = layer;
                layer.setStyle({ color: "#ffff00", weight: 5, fillOpacity: 0.45 });
                layer.openPopup();
              });
            }
          }).addTo(map);

          // 3) –§–æ–∫—É—Å
          const parcelsBounds = parcelsLayer.getBounds();
          const baseBounds = baseLayer.getBounds();
          const focusBounds = (parcelsBounds && parcelsBounds.isValid()) ? parcelsBounds : baseBounds;

          if (!focusBounds || !focusBounds.isValid()) {
            alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã");
            return;
          }
          map.fitBounds(focusBounds, { padding: [20, 20] });

          // 4) –ö–Ω–æ–ø–∫–∏
          const ButtonsControl = L.Control.extend({
            options: { position: "bottomleft" },
            onAdd: function () {
              const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

              const btnZoomIn = L.DomUtil.create("button", "", container);
              btnZoomIn.type = "button";
              btnZoomIn.innerText = "‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å";

              const btnZoomOut = L.DomUtil.create("button", "", container);
              btnZoomOut.type = "button";
              btnZoomOut.innerText = "‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å";

              const btnFocus = L.DomUtil.create("button", "", container);
              btnFocus.type = "button";
              btnFocus.innerText = "üîç –ö —É—á–∞—Å—Ç–∫–∞–º";

              const btnOverview = L.DomUtil.create("button", "", container);
              btnOverview.type = "button";
              btnOverview.innerText = "üåç –û–±–∑–æ—Ä";

              L.DomEvent.disableClickPropagation(container);
              L.DomEvent.disableScrollPropagation(container);

              function bind(btn, handler) {
                L.DomEvent.on(btn, "click", function (e) {
                  L.DomEvent.stop(e);
                  handler();
                });
              }

              bind(btnZoomIn, () => map.flyTo(map.getCenter(), map.getZoom() + 2, { duration: 0.4 }));
              bind(btnZoomOut, () => map.flyTo(map.getCenter(), map.getZoom() - 2, { duration: 0.4 }));
              bind(btnFocus, () => map.fitBounds(focusBounds, { padding: [20, 20], maxZoom: 18 }));
              bind(btnOverview, () => map.fitBounds(focusBounds, { padding: [100, 100] }));

              return container;
            }
          });

          map.addControl(new ButtonsControl());
        })
        .catch(err => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:", err);
          alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ —Ç–æ–∫–µ–Ω.");
        });
    })();
  </script>
</body>
</html>
