<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

 <style>
  html, body, #map {
    height: 100%;
    margin: 0;
  }

  /* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
  .leaflet-control.custom-buttons {
    background: rgba(255, 255, 255, 0.75);
    padding: 12px;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
  }

  /* –ë–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ –ø–∞–ª–µ—Ü —Å –ø–æ—á—Ç–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º */
  .leaflet-control.custom-buttons button {
    display: block;
    width: 360px;
    min-height: 96px;
    margin: 18px 0;
    padding: 24px 28px;
    font-size: 28px;
    border-radius: 18px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    background: rgba(255, 255, 255, 0.08);
    color: #000;
    cursor: pointer;
    backdrop-filter: blur(2px);
    text-shadow: 0 1px 2px rgba(0,0,0,0.35);  /* ‚Üê —Ç–µ–Ω—å —Ç–µ–∫—Å—Ç–∞ */
  }

  .leaflet-control.custom-buttons button:hover {
    background: rgba(255, 255, 255, 0.18);
  }

  .leaflet-top, .leaflet-bottom {
    z-index: 1000;
  }

  .leaflet-bottom {
    padding-bottom: env(safe-area-inset-bottom, 12px);
  }

  .leaflet-control.custom-buttons button + button {
    margin-top: 18px;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    document.body.innerHTML = "‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞";
    throw new Error("No token");
  }

  const map = L.map('map', { zoomControl: false });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  fetch(`/Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => {
      if (!r.ok) throw new Error("Forbidden or not found");
      return r.json();
    })
    .then(data => {
      const layer = L.geoJSON(data, {
  style: { color: '#ff0000', weight: 2, fillOpacity: 0.25 },

  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};

    const html = `
      <b>–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π ‚Ññ:</b> ${p.cn || "‚Äî"}<br>
      <b>–ü–ª–æ—â–∞–¥—å:</b> ${p.area || "‚Äî"} –º¬≤<br>
      <b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b> ${p.cost || "‚Äî"} ‚ÇΩ<br>
      <b>–¢–∏–ø:</b> ${p.type || "‚Äî"}<br>
      <b>–§–ò–û:</b> ${p.fio || "‚Äî"}<br>
      <b>–ê–¥—Ä–µ—Å:</b> ${p.phone || "‚Äî"}<br>
    `;

    layer.bindPopup(html);
  }
}).addTo(map);

      const goodBounds = L.latLngBounds([]);

      layer.eachLayer(l => {
        if (l.getBounds) {
          const b = l.getBounds();
          const sw = b.getSouthWest();
          const ne = b.getNorthEast();

          if (
            sw.lng > 28 && ne.lng < 35 &&
            sw.lat > 57 && ne.lat < 62
          ) {
            goodBounds.extend(b);
          }
        }
      });

      if (!goodBounds.isValid()) {
        document.body.innerHTML = "‚õî –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö";
        return;
      }

      map.fitBounds(goodBounds, { padding: [50, 50], maxZoom: 18 });
      setTimeout(() => map.invalidateSize(), 200);

      const ButtonsControl = L.Control.extend({
        options: { position: 'bottomleft' },

        onAdd: function () {
  const container = L.DomUtil.create('div', 'leaflet-control custom-buttons');

  const btnZoomIn = L.DomUtil.create('button', '', container);
  btnZoomIn.innerText = '‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å';

  const btnZoomOut = L.DomUtil.create('button', '', container);
  btnZoomOut.innerText = '‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å';

  const btnFocus = L.DomUtil.create('button', '', container);
  btnFocus.innerText = 'üîç –ö —É—á–∞—Å—Ç–∫–∞–º';

  const btnOverview = L.DomUtil.create('button', '', container);
  btnOverview.innerText = 'üåç –û–±–∑–æ—Ä';

  const btnMaxCenter = L.DomUtil.create('button', '', container);
  btnMaxCenter.innerText = 'üéØ –ú–∞–∫—Å. –∫ —Ü–µ–Ω—Ç—Ä—É';

  // –ß—Ç–æ–±—ã —Ç–∞–ø—ã –ø–æ –ø–∞–Ω–µ–ª–∏ –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–ª–∏—Å—å –≤ –∂–µ—Å—Ç—ã –∫–∞—Ä—Ç—ã (Android/WebView)
  L.DomEvent.disableClickPropagation(container);
  L.DomEvent.disableScrollPropagation(container);
  L.DomEvent.on(container, 'touchstart mousedown dblclick', L.DomEvent.stopPropagation);

  // ‚ûï / ‚ûñ –ó—É–º
  btnZoomIn.onclick = () => map.zoomIn();
  btnZoomOut.onclick = () => map.zoomOut();

  // üîç –ö —É—á–∞—Å—Ç–∫–∞–º ‚Äî –±–ª–∏–∂–µ
  btnFocus.onclick = () => {
    map.fitBounds(goodBounds, { padding: [10, 10], maxZoom: 18 });
  };

  // üåç –û–±–∑–æ—Ä ‚Äî –¥–∞–ª—å—à–µ
  btnOverview.onclick = () => {
    map.fitBounds(goodBounds, { padding: [500, 500], maxZoom: 13 });
  };

  // üéØ –ú–∞–∫—Å. ‚Äî –ª–µ—Ç–∏–º –∫ –±–ª–∏–∂–∞–π—à–µ–º—É —É—á–∞—Å—Ç–∫—É –æ—Ç –º–µ–¥–∏–∞–Ω—ã
  btnMaxCenter.onclick = () => {
    const centers = [];

    layer.eachLayer(l => {
      if (l.getBounds) {
        centers.push(l.getBounds().getCenter());
      }
    });

    if (!centers.length) return;

    // –º–µ–¥–∏–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞
    const lats = centers.map(c => c.lat).sort((a,b)=>a-b);
    const lngs = centers.map(c => c.lng).sort((a,b)=>a-b);
    const mid = Math.floor(lats.length / 2);
    const median = L.latLng(lats[mid], lngs[mid]);

    // –±–ª–∏–∂–∞–π—à–∏–π —É—á–∞—Å—Ç–æ–∫ –∫ –º–µ–¥–∏–∞–Ω–µ
    let best = centers[0];
    let bestDist = Infinity;

    centers.forEach(c => {
      const d = median.distanceTo(c);
      if (d < bestDist) {
        bestDist = d;
        best = c;
      }
    });

    map.flyTo(best, 20, { animate: true, duration: 0.6 });
  };

  return container;
}
      });

      map.addControl(new ButtonsControl());
    })
    .catch(err => {
      console.error(err);
      document.body.innerHTML = "‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω –∏–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞";
    });
</script>

</body>
</html>
