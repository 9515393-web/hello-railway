<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }

    /* POPUP –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π */
    .leaflet-popup-content-wrapper { border-radius: 14px; }

    .leaflet-popup-content {
      max-width: 420px !important;
      max-height: 40vh;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.35;
      white-space: normal !important;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    @media (max-width: 600px) {
      .leaflet-popup-content {
        max-width: 92vw !important;
        max-height: 35vh;
      }
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    document.body.innerHTML = "‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞";
    throw new Error("No token");
  }

  const map = L.map("map", { zoomControl: false });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  fetch(`/Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => {
      if (!r.ok) throw new Error("Forbidden or not found");
      return r.json();
    })
    .then(data => {
      let selected = null;

      function isParcel(f) {
        const cn = f?.properties?.cn;
        if (!cn) return false;
        const parts = String(cn).split(":");
        return parts.length >= 4 && parts[3] && parts[3].length > 0;
      }

      // —Å–ª–æ–π —É—á–∞—Å—Ç–∫–æ–≤
      const parcelsLayer = L.geoJSON(data, {
        filter: f => isParcel(f),
        style: {
          color: "#ff0000",
          weight: 2,
          fillOpacity: 0.20
        },

        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};

          const cn   = p.cn || "‚Äî";
          const area = p.area || "‚Äî";
          const cost = p.cost || "‚Äî";
          const type = p.type || "‚Äî";
          const fio  = p.fio || "‚Äî";
          const addr = p.phone || "‚Äî";

          const html = `
            <div style="padding:6px; font-size:16px;">
              <div style="font-size:18px; font-weight:700; margin-bottom:6px;">
                –ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫
              </div>
              <table style="width:100%; border-collapse: collapse;">
                <tr><td>–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä</td><td><b>${cn}</b></td></tr>
                <tr><td>–ê–¥—Ä–µ—Å</td><td>${addr}</td></tr>
                <tr><td>–ü–ª–æ—â–∞–¥—å</td><td>${area} –º¬≤</td></tr>
                <tr><td>–°—Ç–æ–∏–º–æ—Å—Ç—å</td><td><b>${cost}</b> ‚ÇΩ</td></tr>
                <tr><td>–¢–∏–ø</td><td>${type}</td></tr>
                <tr><td>–§–ò–û</td><td>${fio}</td></tr>
              </table>
            </div>
          `;

          layer.bindPopup(html, {
            maxWidth: 420,
            autoPan: true,
            autoPanPadding: [20, 80]
          });

          layer.on("click", () => {
            if (selected && selected !== layer) {
              selected.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.20 });
            }
            selected = layer;
            layer.setStyle({ color: "#ffff00", weight: 4, fillOpacity: 0.40 });
            layer.openPopup();
          });
        }
      }).addTo(map);

      // –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ —É—á–∞—Å—Ç–∫–∞–º
      const goodBounds = L.latLngBounds([]);
      parcelsLayer.eachLayer(l => {
        if (l.getBounds) goodBounds.extend(l.getBounds());
      });

      if (goodBounds.isValid()) {
        map.fitBounds(goodBounds, { padding: [50, 50], maxZoom: 18 });
      }

      setTimeout(() => map.invalidateSize(), 200);

      // -------- –ö–ù–û–ü–ö–ò --------
      const ButtonsControl = L.Control.extend({
        options: { position: "bottomleft" },

        onAdd: function () {
          const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

          const btnZoomIn = L.DomUtil.create("button", "", container);
          btnZoomIn.innerText = "‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å";

          const btnZoomOut = L.DomUtil.create("button", "", container);
          btnZoomOut.innerText = "‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å";

          const btnFocus = L.DomUtil.create("button", "", container);
          btnFocus.innerText = "üîç –ö —É—á–∞—Å—Ç–∫–∞–º";

          const btnOverview = L.DomUtil.create("button", "", container);
          btnOverview.innerText = "üåç –û–±–∑–æ—Ä";

          const btnMaxCenter = L.DomUtil.create("button", "", container);
          btnMaxCenter.innerText = "üéØ –ú–∞–∫—Å. –∫ —Ü–µ–Ω—Ç—Ä—É";

          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);
          L.DomEvent.on(container, "touchstart mousedown dblclick", L.DomEvent.stopPropagation);

          btnZoomIn.onclick = () => map.zoomIn();
          btnZoomOut.onclick = () => map.zoomOut();

          btnFocus.onclick = () => {
            map.fitBounds(goodBounds, { padding: [10, 10], maxZoom: 18 });
          };

          btnOverview.onclick = () => {
            map.fitBounds(goodBounds, { padding: [500, 500], maxZoom: 13 });
          };

          btnMaxCenter.onclick = () => {
            const centers = [];
            parcelsLayer.eachLayer(l => {
              if (l.getBounds) centers.push(l.getBounds().getCenter());
            });
            if (!centers.length) return;

            const lats = centers.map(c => c.lat).sort((a, b) => a - b);
            const lngs = centers.map(c => c.lng).sort((a, b) => a - b);
            const mid = Math.floor(lats.length / 2);
            const median = L.latLng(lats[mid], lngs[mid]);

            let best = centers[0];
            let bestDist = Infinity;

            centers.forEach(c => {
              const d = median.distanceTo(c);
              if (d < bestDist) {
                bestDist = d;
                best = c;
              }
            });

            map.flyTo(best, 20, { animate: true, duration: 0.6 });
          };

          return container;
        }
      });

      map.addControl(new ButtonsControl());
    })
    .catch(err => {
      console.error(err);
      document.body.innerHTML = "‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω –∏–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞";
    });
</script>

</body>
</html>
