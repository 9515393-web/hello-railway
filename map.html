<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
  html, body, #map {
    height: 100%;
    margin: 0;
  }

 /* POPUP –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –∏ —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–π */
.leaflet-popup-content-wrapper {
  border-radius: 14px;
}

.leaflet-popup-content {
  width: 420px !important;     /* –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –Ω–∞ –ü–ö */
  max-width: 92vw !important;  /* –ø–æ—á—Ç–∏ –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
  max-height: 60vh;            /* –Ω–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã—Å–æ–∫–∏–π */
  overflow-y: auto;

  font-size: 16px;
  line-height: 1.4;

  white-space: normal !important;
  word-break: normal;          /* ‚ùó –Ω–µ –ª–æ–º–∞–µ–º —Å–ª–æ–≤–∞ –ø–æ –±—É–∫–≤–∞–º */
  overflow-wrap: break-word;   /* –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Ç–æ–ª—å–∫–æ –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞/–Ω–æ–º–µ—Ä–∞ */
}

/* –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
@media (max-width: 768px) {
  .leaflet-popup-content {
    font-size: 18px;
    max-height: 70vh;
  }

  .leaflet-popup-close-button {
    font-size: 28px !important;
  }
}

 /* üì± –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: –±–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ —Å—Ç–æ–ª–±–∏–∫ —Å–Ω–∏–∑—É —Å–ª–µ–≤–∞ */
@media (max-width: 768px) {
  /* –ü–∞–Ω–µ–ª—å –≤–Ω–∏–∑—É —Å–ª–µ–≤–∞ */
  .leaflet-bottom.leaflet-left .leaflet-control.custom-buttons {
    margin: 12px;
  }

  .leaflet-control.custom-buttons {
    display: flex;
    flex-direction: column;   /* –°–¢–û–õ–ë–ò–ö–û–ú */
    gap: 12px;                /* —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
    padding: 16px;
    border-radius: 20px;
  }

  .leaflet-control.custom-buttons button {
    width: 90vw;        /* –ø–æ—á—Ç–∏ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ */
    min-height: 90px;   /* –µ—â—ë –≤—ã—à–µ –ø–æ–¥ –ø–∞–ª–µ—Ü */
    padding: 20px 24px;
    font-size: 26px;    /* –∫—Ä—É–ø–Ω—ã–π —Ç–µ–∫—Å—Ç */
    border-radius: 20px;
  }
}
</style>
</head>
<body>
<div id="map"></div>

<script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    document.body.innerHTML = "‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞";
    throw new Error("No token");
  }

  const map = L.map("map", { zoomControl: false });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  fetch(`/Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => {
      if (!r.ok) throw new Error("Forbidden or not found");
      return r.json();
    })
    .then(data => {
      let selected = null;
      function isRealParcel(feature) {
        const cn = feature?.properties?.cn;
        if (!cn) return false;

        const parts = String(cn).split(":");
        // –£ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ 4 —á–∞—Å—Ç–∏: 47:26:0414001:XXX
        return parts.length === 4 && parts[3] && parts[3].length > 0;
      }

      const parcelsLayer = L.geoJSON(data, {
  style: {
    color: "#ff0000",
    weight: 2,
    fillOpacity: 0.20
  },

  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};

    // –í–†–ï–ú–ï–ù–ù–û: –ø–æ–∫–∞–∂–µ–º –≤—Å–µ –ø–æ–ª—è, –∫–∞–∫ –æ–Ω–∏ —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å
    const cn    = p.cn || "‚Äî";
const area  = p.area || "‚Äî";
const cost  = p.cost || "‚Äî";
const type  = p.type || "‚Äî";
const addr  = p.address || p.addr || p.location || "‚Äî"; // –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è
const cat   = p.category || "‚Äî";
const use   = p.use || p.vri || "‚Äî";

const html = `
  <div style="font-size:16px; line-height:1.4;">
    <div style="font-size:18px; font-weight:700; margin-bottom:8px;">
      –ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫
    </div>

    <table style="width:100%; border-collapse:collapse;">
      <tr>
        <td style="color:#666; padding:4px 6px;">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π ‚Ññ</td>
        <td style="padding:4px 6px;"><b>${cn}</b></td>
      </tr>
      <tr>
        <td style="color:#666; padding:4px 6px;">–ê–¥—Ä–µ—Å</td>
        <td style="padding:4px 6px;">${addr}</td>
      </tr>
      <tr>
        <td style="color:#666; padding:4px 6px;">–ü–ª–æ—â–∞–¥—å</td>
        <td style="padding:4px 6px;">${area} –º¬≤</td>
      </tr>
      <tr>
        <td style="color:#666; padding:4px 6px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</td>
        <td style="padding:4px 6px;">${cat}</td>
      </tr>
      <tr>
        <td style="color:#666; padding:4px 6px;">–í–†–ò</td>
        <td style="padding:4px 6px;">${use}</td>
      </tr>
      <tr>
        <td style="color:#666; padding:4px 6px;">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</td>
        <td style="padding:4px 6px;"><b>${cost}</b></td>
      </tr>
      <tr>
        <td style="color:#666; padding:4px 6px;">–¢–∏–ø</td>
        <td style="padding:4px 6px;">${type}</td>
      </tr>
    </table>
  </div>
`;

layer.bindPopup(html, {
  maxWidth: 600,          // —Ä–∞–∑—Ä–µ—à–∞–µ–º –±—ã—Ç—å —à–∏—Ä–µ
  autoPan: true,
  autoPanPadding: [20, 80]
});


    layer.on("click", () => {
      layer.openPopup();
    });
  }
}).addTo(map);


      // –≥—Ä–∞–Ω–∏—Ü—ã ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–º –ø–æ–ª–∏–≥–æ–Ω–∞–º
const goodBounds = L.latLngBounds([]);

parcelsLayer.eachLayer(l => {
  try {
    if (!l.getBounds) return;

    const b = l.getBounds();

    // –∑–∞—â–∏—Ç–∞ –æ—Ç –±–∏—Ç—ã—Ö/–∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö bounds
    if (!b.isValid()) return;

    const sw = b.getSouthWest();
    const ne = b.getNorthEast();

    // —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–≤–æ–µ–º—É —Ä–µ–≥–∏–æ–Ω—É (–õ–µ–Ω–æ–±–ª–∞—Å—Ç—å / –°–ü–± ‚Äî –ø–æ–¥—Å—Ç—Ä–æ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    if (
      sw.lng > 20 && ne.lng < 50 &&
      sw.lat > 50 && ne.lat < 70
    ) {
      goodBounds.extend(b);
    }
  } catch (e) {
    // –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫—Ä–∏–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
  }
});

if (goodBounds.isValid()) {
  map.fitBounds(goodBounds, { padding: [50, 50], maxZoom: 18 });
} else {
  console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã, —Å—Ç–∞–≤–∏–º –∑–∞–ø–∞—Å–Ω–æ–π –∑—É–º");
  map.setView([59.9, 30.3], 10); // –∑–∞–ø–∞—Å–Ω–æ–π —Ü–µ–Ω—Ç—Ä (–°–ü–±), –ø–æ–º–µ–Ω—è–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
}

      setTimeout(() => map.invalidateSize(), 200);

      // -------- –ö–ù–û–ü–ö–ò --------
      const ButtonsControl = L.Control.extend({
        options: { position: "bottomleft" },

        onAdd: function () {
          const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

          const btnZoomIn = L.DomUtil.create("button", "", container);
          btnZoomIn.innerText = "‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å";

          const btnZoomOut = L.DomUtil.create("button", "", container);
          btnZoomOut.innerText = "‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å";

          const btnFocus = L.DomUtil.create("button", "", container);
          btnFocus.innerText = "üîç –ö —É—á–∞—Å—Ç–∫–∞–º";

          const btnOverview = L.DomUtil.create("button", "", container);
          btnOverview.innerText = "üåç –û–±–∑–æ—Ä";

          const btnMaxCenter = L.DomUtil.create("button", "", container);
          btnMaxCenter.innerText = "üéØ –ú–∞–∫—Å. –∫ —Ü–µ–Ω—Ç—Ä—É";

          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);
          L.DomEvent.on(container, "touchstart mousedown dblclick", L.DomEvent.stopPropagation);

          btnZoomIn.onclick = () => map.zoomIn();
          btnZoomOut.onclick = () => map.zoomOut();

          btnFocus.onclick = () => {
            map.fitBounds(goodBounds, { padding: [10, 10], maxZoom: 18 });
          };

          btnOverview.onclick = () => {
            map.fitBounds(goodBounds, { padding: [500, 500], maxZoom: 13 });
          };

          btnMaxCenter.onclick = () => {
            const centers = [];
            parcelsLayer.eachLayer(l => {
              if (l.getBounds) centers.push(l.getBounds().getCenter());
            });
            if (!centers.length) return;

            const lats = centers.map(c => c.lat).sort((a, b) => a - b);
            const lngs = centers.map(c => c.lng).sort((a, b) => a - b);
            const mid = Math.floor(lats.length / 2);
            const median = L.latLng(lats[mid], lngs[mid]);

            let best = centers[0];
            let bestDist = Infinity;

            centers.forEach(c => {
              const d = median.distanceTo(c);
              if (d < bestDist) {
                bestDist = d;
                best = c;
              }
            });

            map.flyTo(best, 20, { animate: true, duration: 0.6 });
          };

          return container;
        }
      });

      map.addControl(new ButtonsControl());
    })
    .catch(err => {
      console.error(err);
      document.body.innerHTML = "‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω –∏–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞";
    });
</script>

</body>
</html>
