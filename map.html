<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .leaflet-popup-content-wrapper { border-radius: 14px; }
    .leaflet-popup-content{
      width: 420px !important;
      max-width: 420px !important;
      max-height: 60vh;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.4;
      white-space: normal !important;
      word-break: normal;
      overflow-wrap: break-word;
    }
    .popup-root{ font-size: 16px; line-height: 1.4; }

    .leaflet-control.custom-buttons{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      border-radius:16px;
      background:rgba(255,255,255,0.9);
      pointer-events:auto;
      z-index:1000;
    }
    .leaflet-control.custom-buttons button{
      min-height:48px;
      padding:10px 14px;
      font-size:16px;
      border-radius:12px;
      pointer-events:auto;
      cursor:pointer;
    }

    .parcel-label{
      background:transparent !important;
      border:none !important;
      box-shadow:none !important;
      color:#111 !important;
      font-weight:700 !important;
      font-size:12px !important;
      text-shadow:0 0 2px #fff, 0 0 2px #fff;
    }
    .leaflet-tooltip { pointer-events: none; }
    .leaflet-tooltip-pane { z-index: 650; }
  </style>
</head>
<body>
<div id="map"></div>

<script>
console.log("VERSION: NORMALIZED POPUPS ONLY");

(function () {
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");
  if (!token) { alert("‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞"); throw new Error("No token"); }

  const map = L.map("map", { zoomControl: false, tap: true, touchZoom: true });
  setTimeout(() => map.invalidateSize(true), 0);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  function extractPlotNumberFromCard(card) {
    const raw = String(card || "");
    const addrLineMatch = raw.match(/^\s*1\.\s*–ê–¥—Ä–µ—Å:\s*([\s\S]*?);/mi);
    const addr = (addrLineMatch ? addrLineMatch[1] : raw)
      .replace(/\s+/g, " ")
      .trim();

    let m = addr.match(/\b—É—á–∞—Å—Ç–æ–∫\s*‚Ññ\s*(\d+)\b/i);
    if (m) return m[1];

    m = addr.match(/\b(?:–∑–µ–º–µ–ª—å–Ω—ã–π\s+)?—É—á–∞—Å—Ç–æ–∫\s+(\d+)\b/i);
    if (m) return m[1];

    const all = [];
    const re = /\b—É—á\.\s*‚Ññ?\s*(\d+)\b/ig;
    let mm;
    while ((mm = re.exec(addr)) !== null) all.push(mm[1]);

    if (all.length === 0) return "";
    const not47 = all.find(x => x !== "47");
    if (not47) return not47;
    return "";
  }

  // –ù–û–†–ú–ê–õ–ò–ó–ê–¢–û–† POPUP ‚Äî –±–µ—Ä—ë—Ç –¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û –∏–∑ card_final
  function buildPopupFromCardFinal(card) {
    const raw = String(card || "");

    // –ê–¥—Ä–µ—Å
    const addrMatch = raw.match(/–ê–¥—Ä–µ—Å:\s*([^;]+);?/i);
    const address = addrMatch ? addrMatch[1].trim() : "‚Äî";

    // –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä
    const cadMatch = raw.match(/\b\d{2}:\d{2}:\d{7}:\d+\b/);
    const cadastre = cadMatch ? cadMatch[0] : "‚Äî";

    // –ü–ª–æ—â–∞–¥—å
    const areaMatch = raw.match(/–ü–ª–æ—â–∞–¥—å\s+(?:–∑–µ–º–µ–ª—å–Ω–æ–≥–æ\s+)?—É—á–∞—Å—Ç–∫–∞\s*([\d.,]+)/i);
    const area = areaMatch ? areaMatch[1].replace(",", ".") : "‚Äî";

    return `
–ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫;<br>
1. –ê–¥—Ä–µ—Å: ${address};<br>
2. –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä ${cadastre};<br>
3. –ü–ª–æ—â–∞–¥—å –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ ${area};<br>
4. –§.–ò.–û. _______________________;<br>
5. –ö–æ–Ω—Ç–∞–∫—Ç—ã ______________________.
    `.trim();
  }

  fetch(`Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
    .then(data => {

      // –ü–æ–¥–ª–æ–∂–∫–∞ ‚Äî –≤—Å–µ –≥—Ä–∞–Ω–∏—Ü—ã
      const baseLayer = L.geoJSON(data, {
        interactive: false,
        style: { color: "#ff0000", weight: 1, opacity: 0.35, fill: false }
      }).addTo(map);

      // –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
      // –†–µ–≥–µ–∫—Å–ø –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞
const CAD_REGEX = /(?:–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π\s+–Ω–æ–º–µ—Ä\s*)?(\d{2}\s*:\s*\d{2}\s*:\s*\d{6,8}\s*:\s*\d+)/i;

// –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ ‚Äî –¢–û–õ–¨–ö–û –ù–ï–ü–†–û–ë–õ–ï–ú–ù–´–ï
const parcelsLayer = L.geoJSON(data, {
  interactive: true,
  bubblingMouseEvents: false,
  style: { color: "#ff0000", weight: 2, fillOpacity: 0.20 },

  // –§–ò–õ–¨–¢–†: –∏—Å–∫–ª—é—á–∞–µ–º —É—á–∞—Å—Ç–∫–∏ –±–µ–∑ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –≤ card_final
  filter: (feature) => {
    const rawCard = String(feature?.properties?.card_final || "");
    const m = rawCard.match(CAD_REGEX);
    return !!m; // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ –Ω–æ–º–µ—Ä –Ω–∞–π–¥–µ–Ω
  },

  onEachFeature: (feature, layer) => {
  const rawCard = String(feature?.properties?.card_final || "").trim();
  if (!rawCard) return;

  const plotNum = extractPlotNumberFromCard(rawCard);
  if (!plotNum) return;

  // –ö–ª—é—á —É—á–∞—Å—Ç–∫–∞: –Ω–∞–ø—Ä–∏–º–µ—Ä "2-102"
  const plotKey = plotNum.includes("-") ? plotNum : `2-${plotNum}`;

  // –¢—É–ª—Ç–∏–ø —Å –Ω–æ–º–µ—Ä–æ–º
  if (layer.getBounds && layer.getBounds().isValid()) {
    layer.bindTooltip(plotNum, {
      permanent: true,
      direction: "center",
      className: "parcel-label"
    });
  }

  layer.on("click", async () => {
    layer.setStyle({ color: "#ff0000", weight: 5, fillOpacity: 0.35 });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
    let data = { fio: "", phone: "", note: "" };
    try {
      const r = await fetch(`/api/plot/${plotKey}`);
      if (r.ok) {
        const j = await r.json();
        data.fio = j.fio || "";
        data.phone = j.phone || "";
        data.note = j.note || "";
      }
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–∞", e);
    }

    const baseHtml = buildPopupFromCardFinal(rawCard);

    const formHtml = `
      <hr>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <label>–§–ò–û:<br>
          <input id="pf-fio" type="text" style="width:100%" value="${data.fio}">
        </label>
        <label>–¢–µ–ª–µ—Ñ–æ–Ω:<br>
          <input id="pf-phone" type="text" style="width:100%" value="${data.phone}">
        </label>
        <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:<br>
          <textarea id="pf-note" style="width:100%">${data.note}</textarea>
        </label>
        <button id="pf-save" style="padding:8px; font-size:16px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div id="pf-status" style="font-size:14px;"></div>
      </div>
    `;

    const popupHtml = `
      <div class="popup-root">
        <div>${baseHtml}</div>
        ${formHtml}
      </div>
    `;

    layer.bindPopup(popupHtml, { maxWidth: 9999, autoPan: true });
    layer.openPopup();

    // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–ø–∞–ø–∞
    setTimeout(() => {
      const btn = document.getElementById("pf-save");
      if (!btn) return;

      btn.onclick = async () => {
        const fio = document.getElementById("pf-fio").value;
        const phone = document.getElementById("pf-phone").value;
        const note = document.getElementById("pf-note").value;
        const status = document.getElementById("pf-status");

        status.textContent = "–°–æ—Ö—Ä–∞–Ω—è—é...";

        try {
          const resp = await fetch(`/api/plot/${plotKey}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fio, phone, note })
          });

          if (resp.ok) {
            status.textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
          } else {
            status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
          }
        } catch (e) {
          console.error(e);
          status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
        }
      };
    }, 50);
  });
}
}).addTo(map);

      const focusBounds = parcelsLayer.getBounds().isValid() ? parcelsLayer.getBounds() : baseLayer.getBounds();
      if (focusBounds && focusBounds.isValid()) {
        map.fitBounds(focusBounds, { padding: [20, 20] });
      }

      const ButtonsControl = L.Control.extend({
        options: { position: "bottomleft" },
        onAdd: function () {
          const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

          const btnZoomIn = L.DomUtil.create("button", "", container);
          btnZoomIn.innerText = "‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å";
          const btnZoomOut = L.DomUtil.create("button", "", container);
          btnZoomOut.innerText = "‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å";
          const btnFocus = L.DomUtil.create("button", "", container);
          btnFocus.innerText = "üîç –ö —É—á–∞—Å—Ç–∫–∞–º";
          const btnOverview = L.DomUtil.create("button", "", container);
          btnOverview.innerText = "üåç –û–±–∑–æ—Ä";

          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.on(btnZoomIn, "click", () => map.flyTo(map.getCenter(), map.getZoom() + 2, { duration: 0.4 }));
          L.DomEvent.on(btnZoomOut, "click", () => map.flyTo(map.getCenter(), map.getZoom() - 2, { duration: 0.4 }));
          L.DomEvent.on(btnFocus, "click", () => map.fitBounds(focusBounds, { padding: [20, 20], maxZoom: 18 }));
          L.DomEvent.on(btnOverview, "click", () => map.fitBounds(focusBounds, { padding: [100, 100] }));

          return container;
        }
      });

      map.addControl(new ButtonsControl());
    })
    .catch(err => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:", err);
      alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ —Ç–æ–∫–µ–Ω.");
    });

})();
</script>
</body>
</html>
