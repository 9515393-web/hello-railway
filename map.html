<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .leaflet-popup-content-wrapper { border-radius: 14px; }
    .leaflet-popup-content{
      width: 420px !important;
      max-width: 420px !important;
      max-height: 60vh;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.4;
      white-space: normal !important;
      word-break: normal;
      overflow-wrap: break-word;
    }
    .popup-root{ font-size: 16px; line-height: 1.4; }

    .leaflet-control.custom-buttons{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      border-radius:16px;
      background:rgba(255,255,255,0.9);
      pointer-events:auto;
      z-index:1000;
    }
    .leaflet-control.custom-buttons button{
      min-height:48px;
      padding:10px 14px;
      font-size:16px;
      border-radius:12px;
      pointer-events:auto;
      cursor:pointer;
    }

    .parcel-label{
      background:transparent !important;
      border:none !important;
      box-shadow:none !important;
      color:#111 !important;
      font-weight:700 !important;
      font-size:12px !important;
      text-shadow:0 0 2px #fff, 0 0 2px #fff;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
console.log("MAP SCRIPT LOADED");
console.log("SCRIPT VERSION 2026-02-19 STRICT_INTERACTIVE_VALID_PLOTS");

(function () {
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");
  if (!token) { alert("‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞"); throw new Error("No token"); }

  const map = L.map("map", { zoomControl: false });
  setTimeout(() => map.invalidateSize(true), 0);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  // ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ ‚Ññ47 (–∫–æ—Ç–æ—Ä—ã–µ –ù–ï–õ–¨–ó–Ø –≤—ã–∫–∏–¥—ã–≤–∞—Ç—å)
  const REAL_47_CADASTRES = new Set([
    "47:26:0413001:379",
    "47:26:0414001:88",
    "47:26:0416001:159"
  ]);

  function isPolygonLikeGeometry(feature) {
    const t = String(feature?.geometry?.type || "");
    return t === "Polygon" || t === "MultiPolygon" || t.includes("Polygon");
  }

  function normalizeSpaces(s) {
    return String(s || "").replace(/\s+/g, " ").trim();
  }

  // –ü–æ–ª–Ω—ã–π –∫–∞–¥–∞—Å—Ç—Ä –≤–∏–¥–∞ 47:26:0413001:379
  function extractCadastre(cardFinal) {
    const raw = String(cardFinal || "");
    const m = raw.match(/\b\d{2}:\d{2}:\d{7}:\d+\b/);
    return m ? m[0] : "";
  }

  // –ü–ª–æ—â–∞–¥—å: –±–µ—Ä—ë–º —á–∏—Å–ª–æ –ø–æ—Å–ª–µ "–ü–ª–æ—â–∞–¥—å ... —É—á–∞—Å—Ç–∫–∞"
  function extractArea(cardFinal) {
    const raw = String(cardFinal || "");

    const m =
      raw.match(/–ü–ª–æ—â–∞–¥—å\s+–∑–µ–º–µ–ª—å–Ω–æ–≥–æ\s+—É—á–∞—Å—Ç–∫–∞\s*([\d.,]+)/i) ||
      raw.match(/–ü–ª–æ—â–∞–¥—å\s+—É—á–∞—Å—Ç–∫–∞\s*([\d.,]+)/i) ||
      raw.match(/–ü–ª–æ—â–∞–¥—å\s*([\d.,]+)\s*(?:–∫–≤\.?\s*–º|–º2|–º¬≤)?/i);

    if (!m || !m[1]) return NaN;
    const v = parseFloat(String(m[1]).replace(",", "."));
    return isNaN(v) ? NaN : v;
  }

  // ‚úÖ –ñ—ë—Å—Ç–∫–æ —É–±–∏—Ä–∞–µ–º —Ö–≤–æ—Å—Ç "—É—á. 47" –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω —Ä–µ–∞–ª—å–Ω–æ —Ö–≤–æ—Å—Ç, –∞ –Ω–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞.
  // –õ–æ–≥–∏–∫–∞:
  // - –µ—Å–ª–∏ –∫–∞–¥–∞—Å—Ç—Ä –≤ REAL_47_CADASTRES ‚Üí 47 —Ä–∞–∑—Ä–µ—à—ë–Ω
  // - –∏–Ω–∞—á–µ "—É—á. 47" –≤ –∫–æ–Ω—Ü–µ –∞–¥—Ä–µ—Å–∞ —Å—á–∏—Ç–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–º —Ö–≤–æ—Å—Ç–æ–º –∏ –≤—ã—Ä–µ–∑–∞–µ–º –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  function cleanCardFinalForDisplay(cardFinal) {
    const raw = String(cardFinal || "");
    const cad = extractCadastre(raw);

    if (cad && REAL_47_CADASTRES.has(cad)) {
      return raw; // –Ω–∞—Å—Ç–æ—è—â–∏–π 47 ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–µ–∂–µ–º
    }

    // —Ä–µ–∂–µ–º —Ç–æ–ª—å–∫–æ —Ö–≤–æ—Å—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã "... —É—á. 47;" –∏–ª–∏ "... —É—á.47;" –∏–ª–∏ "... —É—á. 47"
    // –≤–∞–∂–Ω–æ: –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ "47:.."
    return raw.replace(/(\s*,?\s*(?:—É—á|—É—á–∞—Å—Ç–æ–∫)\.\s*‚Ññ?\s*47)\s*;?/ig, (m, g1, offset) => {
      // —Ä–µ–∂–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É —Å—Ç—Ä–æ–∫–∏ –∞–¥—Ä–µ—Å–∞/–∫–∞—Ä—Ç–æ—á–∫–∏, –∞ –Ω–µ –≥–¥–µ-—Ç–æ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ
      // (–ø—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –µ—Å—Ç—å "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π" ‚Äî –∑–Ω–∞—á–∏—Ç —ç—Ç–æ —Ö–≤–æ—Å—Ç –∞–¥—Ä–µ—Å–∞)
      const tail = raw.slice(offset);
      if (/–ö–∞–¥–∞—Å—Ç—Ä–æ–≤/i.test(tail)) return ""; // —Ö–≤–æ—Å—Ç –ø–µ—Ä–µ–¥ "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π" ‚Äî –≤—ã—Ä–µ–∑–∞–µ–º
      // –µ—Å–ª–∏ –ø—Ä—è–º –≤ –∫–æ–Ω—Ü–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–∂–µ –≤—ã—Ä–µ–∑–∞–µ–º
      if (tail.length < 40) return "";
      return m; // –∏–Ω–∞—á–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
    });
  }

  // ‚úÖ –ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞ –±–µ—Ä—ë–º –ò–ó properties.uch_num (—ç—Ç–æ –≥–ª–∞–≤–Ω–æ–µ!)
  // –ï—Å–ª–∏ uch_num = "47" ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∫–∞–¥–∞—Å—Ç—Ä –≤ —Å–ø–∏—Å–∫–µ REAL_47_CADASTRES.
  function getPlotNumber(feature) {
    const rawCard = String(feature?.properties?.card_final || "");
    const cad = extractCadastre(rawCard);

    const num = normalizeSpaces(feature?.properties?.uch_num || "");
    if (!num) return "";

    if (num === "47") {
      return (cad && REAL_47_CADASTRES.has(cad)) ? "47" : "";
    }

    // –î–æ–ø—É—Å–∫–∞–µ–º 154–∞, 73–∞ –∏ —Ç.–ø.
    if (/^\d+[–∞-—èa-z]?$/i.test(num)) return num;

    return "";
  }

  // ‚úÖ –í–∞–ª–∏–¥–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞:
  // - –ü–æ–ª–∏–≥–æ–Ω
  // - card_final –µ—Å—Ç—å
  // - "–ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫;"
  // - –ø–æ–ª–Ω—ã–π –∫–∞–¥–∞—Å—Ç—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
  // - –ø–ª–æ—â–∞–¥—å >= 300 (—É–±–∏—Ä–∞–µ—Ç –º—É—Å–æ—Ä —Ç–∏–ø–∞ 62.05 –∏ —Ç.–ø.)
  // - –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞ –ù–ï –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (—Ç—ã –≥–æ–≤–æ—Ä–∏–ª: –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ —É—á—ë—Ç–µ –±–µ–∑ –Ω–æ–º–µ—Ä–∞)
  //   –Ω–æ –µ—Å–ª–∏ –Ω–æ–º–µ—Ä–∞ –Ω–µ—Ç ‚Äî –±—É–¥–µ—Ç –ø–æ–ø–∞–ø, –ù–û –ë–ï–ó –ü–û–î–ü–ò–°–ò
  function isValidLandPlotForPopup(feature) {
    const raw = String(feature?.properties?.card_final || "").trim();
    if (!raw) return false;

    if (!/^–ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫\s*;/i.test(raw)) return false;

    const cad = extractCadastre(raw);
    if (!cad) return false;

    const area = extractArea(raw);
    if (!isFinite(area) || area < 300) return false;

    return true;
  }

  fetch(`Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
    .then(data => {
      console.log("GEOJSON LOADED", data);
      console.log("FEATURES COUNT:", data.features?.length);

      let selected = null;

      // –ü–æ–¥–ª–æ–∂–∫–∞ ‚Äî –≤—Å–µ –≥—Ä–∞–Ω–∏—Ü—ã (–Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)
      const baseLayer = L.geoJSON(data, {
        interactive: false,
        style: { color: "#ff0000", weight: 1, opacity: 0.35, fill: false }
      }).addTo(map);

      const rejectStats = {
        nonPolygon: 0,
        noCard: 0,
        notLandPlot: 0,
        noCadastre: 0,
        badArea: 0,
        okPopup: 0,
        okWithNumber: 0,
        okNoNumber: 0,
      };

      const parcelsLayer = L.geoJSON(data, {
        interactive: true,

        filter: (feature) => {
          if (!isPolygonLikeGeometry(feature)) { rejectStats.nonPolygon++; return false; }

          const raw = String(feature?.properties?.card_final || "").trim();
          if (!raw) { rejectStats.noCard++; return false; }

          if (!/^–ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫\s*;/i.test(raw)) { rejectStats.notLandPlot++; return false; }

          const cad = extractCadastre(raw);
          if (!cad) { rejectStats.noCadastre++; return false; }

          const area = extractArea(raw);
          if (!isFinite(area) || area < 300) { rejectStats.badArea++; return false; }

          rejectStats.okPopup++;
          return true;
        },

        style: { color: "#ff0000", weight: 2, fillOpacity: 0.20 },

        onEachFeature: (feature, layer) => {
          const rawCard = String(feature?.properties?.card_final || "").trim();

          // POPUP –≤—Å–µ–≥–¥–∞ –¥–ª—è –≤–∞–ª–∏–¥–Ω—ã—Ö (—Ñ–∏–ª—å—Ç—Ä —É–∂–µ –æ—Ç–æ–±—Ä–∞–ª)
          const cleanedForDisplay = cleanCardFinalForDisplay(rawCard);
          const bodyHtml = cleanedForDisplay.replace(/\n/g, "<br>");
          layer.bindPopup(`<div class="popup-root"><div>${bodyHtml}</div></div>`, { maxWidth: 9999, autoPan: true });

          // –ü–æ–¥–ø–∏—Å—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–æ–º–µ—Ä —Ä–µ–∞–ª—å–Ω–æ –≤–∞–ª–∏–¥–µ–Ω
          const num = getPlotNumber(feature);
          if (num) {
            rejectStats.okWithNumber++;
            try {
              if (layer.getBounds && layer.getBounds().isValid()) {
                layer.bindTooltip(num, {
                  permanent: true,
                  direction: "center",
                  className: "parcel-label"
                });
              }
            } catch(e) {}
          } else {
            rejectStats.okNoNumber++;
          }

          // –ö–ª–∏–∫
          layer.on("click", () => {
            if (selected && selected !== layer) {
              selected.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.20 });
            }
            selected = layer;
            layer.setStyle({ color: "#ff0000", weight: 5, fillOpacity: 0.35 });
            layer.openPopup();
          });
        }
      }).addTo(map);

      console.log("REJECT STATS:", rejectStats);

      const parcelsBounds = parcelsLayer.getBounds();
      const baseBounds = baseLayer.getBounds();
      const focusBounds = (parcelsBounds && parcelsBounds.isValid()) ? parcelsBounds : baseBounds;

      if (focusBounds && focusBounds.isValid()) {
        map.fitBounds(focusBounds, { padding: [20, 20] });
      } else {
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã");
      }

      const ButtonsControl = L.Control.extend({
        options: { position: "bottomleft" },
        onAdd: function () {
          const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

          const btnZoomIn = L.DomUtil.create("button", "", container);
          btnZoomIn.type = "button";
          btnZoomIn.innerText = "‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å";

          const btnZoomOut = L.DomUtil.create("button", "", container);
          btnZoomOut.type = "button";
          btnZoomOut.innerText = "‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å";

          const btnFocus = L.DomUtil.create("button", "", container);
          btnFocus.type = "button";
          btnFocus.innerText = "üîç –ö —É—á–∞—Å—Ç–∫–∞–º";

          const btnOverview = L.DomUtil.create("button", "", container);
          btnOverview.type = "button";
          btnOverview.innerText = "üåç –û–±–∑–æ—Ä";

          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);

          L.DomEvent.on(btnZoomIn, "click", (e) => { L.DomEvent.stop(e); map.flyTo(map.getCenter(), map.getZoom() + 2, { duration: 0.4 }); });
          L.DomEvent.on(btnZoomOut, "click", (e) => { L.DomEvent.stop(e); map.flyTo(map.getCenter(), map.getZoom() - 2, { duration: 0.4 }); });
          L.DomEvent.on(btnFocus, "click", (e) => { L.DomEvent.stop(e); map.fitBounds(focusBounds, { padding: [20, 20], maxZoom: 18 }); });
          L.DomEvent.on(btnOverview, "click", (e) => { L.DomEvent.stop(e); map.fitBounds(focusBounds, { padding: [100, 100] }); });

          return container;
        }
      });

      map.addControl(new ButtonsControl());
    })
    .catch(err => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:", err);
      alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ —Ç–æ–∫–µ–Ω.");
    });

})();
</script>
</body>
</html>
