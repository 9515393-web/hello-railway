<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

 <style>
  html, body, #map {
    height: 100%;
    margin: 0;
  }

  /* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
  .leaflet-control.custom-buttons {
    background: rgba(255, 255, 255, 0.75);
    padding: 12px;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
  }

  /* –ë–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ –ø–∞–ª–µ—Ü */
  .leaflet-control.custom-buttons button {
    display: block;
    width: 360px;
    min-height: 96px;
    margin: 18px 0;
    padding: 24px 28px;
    font-size: 28px;
    border-radius: 18px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    background: rgba(255, 255, 255, 0.08);
    color: #000;
    cursor: pointer;
    backdrop-filter: blur(2px);
    text-shadow: 0 1px 2px rgba(0,0,0,0.35);
  }

  .leaflet-control.custom-buttons button:hover {
    background: rgba(255, 255, 255, 0.18);
  }

  .leaflet-top, .leaflet-bottom {
    z-index: 1000;
  }

  .leaflet-bottom {
    padding-bottom: env(safe-area-inset-bottom, 12px);
  }

  .leaflet-control.custom-buttons button + button {
    margin-top: 18px;
  }

  /* ===========================
     POPUP –î–õ–Ø –£–ß–ê–°–¢–ö–û–í (–ú–û–ë–ò–õ–¨–ù–´–ô)
     =========================== */

 .leaflet-popup-content-wrapper {
  border-radius: 14px;
}

.leaflet-popup-content {
  width: 85vw !important;
  max-width: 85vw !important;
  max-height: 40vh;          /* ‚¨Ö –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º */
  overflow-y: auto;

  font-size: 18px;
  line-height: 1.35;

  white-space: normal !important;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.leaflet-popup-close-button {
  font-size: 26px !important;
}
</style>
</head>
<body>
<div id="map"></div>

<script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    document.body.innerHTML = "‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞";
    throw new Error("No token");
  }

  // --- helpers ---
  function esc(v) {
    // —á—Ç–æ–±—ã –Ω–∏–∫–∞–∫–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –Ω–µ –ª–æ–º–∞–ª–∏ HTML –≤ –ø–æ–ø–∞–ø–µ
    return String(v ?? "‚Äî")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function getProp(p, keys) {
    // –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –ø–æ–ª—è –≤ –¥—Ä—É–≥–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ/–Ω–∞–∑–≤–∞–Ω–∏–∏
    for (const k of keys) {
      if (p && p[k] != null && String(p[k]).trim() !== "") return p[k];
    }
    return null;
  }

  const map = L.map("map", { zoomControl: false });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  fetch(`/Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
  .then(r => {
    if (!r.ok) throw new Error("Forbidden or not found");
    return r.json();
  })
  .then(data => {
    let selectedLayer = null;

    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º: —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –∏–ª–∏ –∑–æ–Ω–∞/–ö–ü–¢
    function isParcel(f) {
      const cn = f?.properties?.cn;
      if (!cn) return false;
      const parts = String(cn).split(":");
      return parts.length >= 4 && parts[3] && parts[3].length > 0;
    }

    // —Å–ª–æ–π —É—á–∞—Å—Ç–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –æ–Ω–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã)
    const parcelsLayer = L.geoJSON(data, {
      filter: f => isParcel(f),
      style: {
        color: "#ff0000",
        weight: 2,
        fillOpacity: 0.20
      },

      onEachFeature: (feature, lyr) => {
        const p = feature.properties || {};

        const cn   = p.cn || "‚Äî";
        const area = p.area || "‚Äî";
        const cost = p.cost || "‚Äî";
        const type = p.type || "‚Äî";
        const fio  = p.fio || "‚Äî";
        const addr = p.phone || "‚Äî";

        const html = `
          <div style="padding:8px; font-size:16px;">
            <div style="font-size:18px; font-weight:700; margin-bottom:8px;">
              –ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫
            </div>

            <table style="width:100%; border-collapse: collapse;">
              <tr>
                <td style="padding:4px 6px; color:#555;">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä</td>
                <td style="padding:4px 6px;"><b>${cn}</b></td>
              </tr>
              <tr>
                <td style="padding:4px 6px; color:#555;">–ê–¥—Ä–µ—Å</td>
                <td style="padding:4px 6px;">${addr}</td>
              </tr>
              <tr>
                <td style="padding:4px 6px; color:#555;">–ü–ª–æ—â–∞–¥—å</td>
                <td style="padding:4px 6px;">${area} –º¬≤</td>
              </tr>
              <tr>
                <td style="padding:4px 6px; color:#555;">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</td>
                <td style="padding:4px 6px;"><b>${cost}</b> ‚ÇΩ</td>
              </tr>
              <tr>
                <td style="padding:4px 6px; color:#555;">–¢–∏–ø</td>
                <td style="padding:4px 6px;">${type}</td>
              </tr>
              <tr>
                <td style="padding:4px 6px; color:#555;">–§–ò–û</td>
                <td style="padding:4px 6px;">${fio}</td>
              </tr>
            </table>
          </div>
        `;

        lyr.bindPopup(html, {
          maxWidth: 420,
          autoPan: true,
          autoPanPadding: [20, 80]
        });

        lyr.on("click", () => {
          if (selectedLayer && selectedLayer !== lyr) {
            selectedLayer.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.20 });
          }
          selectedLayer = lyr;
          lyr.setStyle({ color: "#ffff00", weight: 5, fillOpacity: 0.45 });
          lyr.openPopup();
        });
      }
    }).addTo(map);

    // –≤—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ —É—á–∞—Å—Ç–∫–∞–º
    const goodBounds = L.latLngBounds([]);
    parcelsLayer.eachLayer(l => {
      if (l.getBounds) {
        goodBounds.extend(l.getBounds());
      }
    });

    if (goodBounds.isValid()) {
      map.fitBounds(goodBounds, { padding: [50, 50], maxZoom: 18 });
    }

    setTimeout(() => map.invalidateSize(), 200);

    // ‚ö†Ô∏è –í–ê–ñ–ù–û: –Ω–∏–∂–µ —Ç–≤–æ–∏ –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å parcelsLayer, –∞ –Ω–µ layer
    // –í –∫–Ω–æ–ø–∫–µ "üéØ –ú–∞–∫—Å. –∫ —Ü–µ–Ω—Ç—Ä—É" —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–π parcelsLayer.eachLayer(...)
  })
  .catch(err => {
    console.error(err);
    document.body.innerHTML = "‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω –∏–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞";
  });
      fetch(`/Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
  .then(r => {
    if (!r.ok) throw new Error("Forbidden or not found");
    return r.json();
  })
  .then(data => {
    let selectedLayer = null;

    function isParcel(f) {
      const cn = f?.properties?.cn;
      if (!cn) return false;
      const parts = String(cn).split(":");
      return parts.length >= 4 && parts[3] && parts[3].length > 0;
    }

    const parcelsLayer = L.geoJSON(data, {
      filter: f => isParcel(f),
      style: {
        color: "#ff0000",
        weight: 2,
        fillOpacity: 0.20
      },

      onEachFeature: (feature, lyr) => {
        const p = feature.properties || {};

        const cn   = p.cn || "‚Äî";
        const area = p.area || "‚Äî";
        const cost = p.cost || "‚Äî";
        const type = p.type || "‚Äî";
        const fio  = p.fio || "‚Äî";
        const addr = p.phone || "‚Äî";

        const html = `
          <div style="padding:8px; font-size:16px;">
            <div style="font-size:18px; font-weight:700; margin-bottom:8px;">
              –ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫
            </div>

            <table style="width:100%; border-collapse: collapse;">
              <tr><td style="color:#555;">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä</td><td><b>${cn}</b></td></tr>
              <tr><td style="color:#555;">–ê–¥—Ä–µ—Å</td><td>${addr}</td></tr>
              <tr><td style="color:#555;">–ü–ª–æ—â–∞–¥—å</td><td>${area} –º¬≤</td></tr>
              <tr><td style="color:#555;">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</td><td><b>${cost}</b> ‚ÇΩ</td></tr>
              <tr><td style="color:#555;">–¢–∏–ø</td><td>${type}</td></tr>
              <tr><td style="color:#555;">–§–ò–û</td><td>${fio}</td></tr>
            </table>
          </div>
        `;

        lyr.bindPopup(html, { maxWidth: 420, autoPan: true, autoPanPadding: [20, 80] });

        lyr.on("click", () => {
          if (selectedLayer && selectedLayer !== lyr) {
            selectedLayer.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.20 });
          }
          selectedLayer = lyr;
          lyr.setStyle({ color: "#ffff00", weight: 5, fillOpacity: 0.45 });
          lyr.openPopup();
        });
      }
    }).addTo(map);

    // –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ —É—á–∞—Å—Ç–∫–∞–º
    const goodBounds = L.latLngBounds([]);
    parcelsLayer.eachLayer(l => {
      if (l.getBounds) goodBounds.extend(l.getBounds());
    });

    if (goodBounds.isValid()) {
      map.fitBounds(goodBounds, { padding: [50, 50], maxZoom: 18 });
    }

    setTimeout(() => map.invalidateSize(), 200);
  })
  .catch(err => {
    console.error(err);
    document.body.innerHTML = "‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω –∏–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞";
  });
</script>

</body>
</html>
