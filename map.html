<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .leaflet-popup-content-wrapper { border-radius: 14px; }
    .leaflet-popup-content{
      width: 420px !important;
      max-width: 420px !important;
      max-height: 60vh;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.4;
      white-space: normal !important;
      word-break: normal;
      overflow-wrap: break-word;
    }
    .popup-root{ font-size: 16px; line-height: 1.4; }
    .popup-raw { margin-bottom: 12px; }

    .edit-box{
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }
    .edit-row{ margin: 8px 0; }
    .edit-row label{
      display:block;
      font-size: 13px;
      opacity: 0.8;
      margin-bottom: 4px;
    }
    .edit-row input, .edit-row textarea{
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      outline: none;
    }
    .edit-actions{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .btn{
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-save{ background: #1f7ae0; color: #fff; }
    .btn-reload{ background: #eee; }
    .status-line{
      margin-top: 8px;
      font-size: 12px;
      opacity: .75;
    }

    .leaflet-control.custom-buttons{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      border-radius:16px;
      background:rgba(255,255,255,0.9);
      pointer-events:auto;
      z-index:1000;
    }
    .leaflet-control.custom-buttons button{
      min-height:48px;
      padding:10px 14px;
      font-size:16px;
      border-radius:12px;
      pointer-events:auto;
      cursor:pointer;
    }

    .parcel-label{
      background:transparent !important;
      border:none !important;
      box-shadow:none !important;
      color:#111 !important;
      font-weight:700 !important;
      font-size:12px !important;
      text-shadow:0 0 2px #fff, 0 0 2px #fff;
    }
    .leaflet-tooltip { pointer-events: none; }
    .leaflet-tooltip-pane { z-index: 650; }
  </style>
</head>
<body>
<div id="map"></div>

<script>
console.log("VERSION: POPUP = RAW card_final + editable fio/phone/note (DB)");

function isLandParcel(feature) {
  const raw = String(feature?.properties?.card_final || "");
  const m = raw.match(/–ü–ª–æ—â–∞–¥—å\s+–∑–µ–º–µ–ª—å–Ω–æ–≥–æ\s+—É—á–∞—Å—Ç–∫–∞\s+(\d+)/i);
  if (!m) return false;
  const area = Number(m[1]);
  return area >= 400;
}

(function () {
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");
  if (!token) { alert("‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞"); throw new Error("No token"); }

  const map = L.map("map", { zoomControl: false, tap: true, touchZoom: true });
  setTimeout(() => map.invalidateSize(true), 0);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  // –ñ–Å–°–¢–ö–û: card_final –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (–Ω–∏–∫–∞–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞)
  function cardFinalToHtml(rawCard) {
    return escapeHtml(rawCard).replace(/\n/g, "<br>");
  }

  // plot_key = "<–Ω–æ–º–µ—Ä –°–ù–¢>-<–Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞>"
  // –°–ù–¢ –±–µ—Ä—ë–º –∏–∑ —Å—Ç—Ä–æ–∫–∏ –∞–¥—Ä–µ—Å–∞: –ó–∞—Ö–æ–∂—å–µ-2, –ó–∞—Ö–æ–∂—å–µ-6 –∏ —Ç.–ø.
  function getPlotKey(feature) {
    const uch = String(feature?.properties?.uch_num || "").trim();
    const card = String(feature?.properties?.card_final || "");

    // –∏—â–µ–º "–ó–∞—Ö–æ–∂—å–µ-2" / "–ó–∞—Ö–æ–∂—å–µ - 2" / '–¢–°–ù "–ó–∞—Ö–æ–∂—å–µ-6"' –∏ —Ç.–¥.
    const m = card.match(/–ó–∞—Ö–æ–∂—å–µ\s*[-‚Äì‚Äî]?\s*(2|3|4|5|6)\b/i);
    const snt = m ? m[1] : "0"; // 0 = –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –Ω–∞—à–ª–∏

    return `${snt}-${uch || "?"}`;
  }

  // –ø–æ–¥–ø–∏—Å–∏ —É—á–∞—Å—Ç–∫–æ–≤ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ popup)
  function extractPlotNumberFromCard(card) {
    const raw = String(card || "");
    const addrLineMatch = raw.match(/^\s*1\.\s*–ê–¥—Ä–µ—Å:\s*([\s\S]*?);/mi);
    const addr = (addrLineMatch ? addrLineMatch[1] : raw)
      .replace(/\s+/g, " ")
      .trim();

    let m = addr.match(/\b—É—á\.\s*(\d+)\b/i);
    if (m) return m[1];

    m = addr.match(/\b—É—á–∞—Å—Ç–æ–∫\s*‚Ññ?\s*(\d+)\b/i);
    if (m) return m[1];

    m = addr.match(/\b—É—á\.\s*‚Ññ?\s*(\d+)\b/i);
    if (m) return m[1];

    return "";
  }

  async function apiGetPlot(plotKey) {
    const r = await fetch(`/api/plot/${encodeURIComponent(plotKey)}?token=${encodeURIComponent(token)}`);
    if (!r.ok) throw new Error("GET /api/plot failed: " + r.status);
    return await r.json();
  }

  async function apiSavePlot(plotKey, payload) {
    const r = await fetch(`/api/plot/${encodeURIComponent(plotKey)}?token=${encodeURIComponent(token)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error("POST /api/plot failed: " + r.status);
    return await r.json();
  }

  function renderPopupHtml(rawCard, plotKey) {
    const rawHtml = rawCard ? cardFinalToHtml(rawCard) : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö card_final";

    // –í–∞–∂–Ω–æ: —É —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ id –ø–æ plotKey (–∏–Ω–∞—á–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø–∞–ø–∞—Ö)
    const fioId = `fio-${plotKey}`;
    const phoneId = `phone-${plotKey}`;
    const noteId = `note-${plotKey}`;
    const statusId = `status-${plotKey}`;
    const saveId = `save-${plotKey}`;
    const reloadId = `reload-${plotKey}`;

    return `
      <div class="popup-root" data-plotkey="${escapeHtml(plotKey)}">
        <div class="popup-raw">${rawHtml}</div>

        <div class="edit-box">
          <div style="font-weight:700;margin-bottom:6px;">‚úçÔ∏è –î–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)</div>

          <div class="edit-row">
            <label for="${fioId}">–§.–ò.–û.</label>
            <input id="${fioId}" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û">
          </div>

          <div class="edit-row">
            <label for="${phoneId}">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="${phoneId}" type="text" placeholder="+7...">
          </div>

          <div class="edit-row">
            <label for="${noteId}">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
            <textarea id="${noteId}" rows="3" placeholder="–õ—é–±–∞—è –∑–∞–º–µ—Ç–∫–∞..."></textarea>
          </div>

          <div class="edit-actions">
            <button class="btn btn-reload" id="${reloadId}">‚ôªÔ∏è –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn btn-save" id="${saveId}">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>

          <div class="status-line" id="${statusId}">plot_key: ${escapeHtml(plotKey)}</div>
        </div>
      </div>
    `.trim();
  }

  async function bindPopupLogic(layer, feature) {
    const rawCard = String(feature?.properties?.card_final || "").trim();
    const plotKey = getPlotKey(feature);

    layer.bindPopup(
      renderPopupHtml(rawCard, plotKey),
      { maxWidth: 9999, autoPan: true }
    );

    // –ö–æ–≥–¥–∞ –ø–æ–ø–∞–ø –æ—Ç–∫—Ä—ã–ª—Å—è ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –∏ –≤–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    layer.on("popupopen", async () => {
      const fioEl = document.getElementById(`fio-${plotKey}`);
      const phoneEl = document.getElementById(`phone-${plotKey}`);
      const noteEl = document.getElementById(`note-${plotKey}`);
      const statusEl = document.getElementById(`status-${plotKey}`);
      const saveBtn = document.getElementById(`save-${plotKey}`);
      const reloadBtn = document.getElementById(`reload-${plotKey}`);

      const setStatus = (t) => { if (statusEl) statusEl.textContent = t; };

      const load = async () => {
        try {
          setStatus("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î...");
          const data = await apiGetPlot(plotKey);
          if (fioEl) fioEl.value = data.fio ?? "";
          if (phoneEl) phoneEl.value = data.phone ?? "";
          if (noteEl) noteEl.value = data.note ?? "";
          setStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ. updated_at: ${data.updated_at ?? "‚Äî"}`);
        } catch (e) {
          console.error(e);
          setStatus("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –ë–î (—Å–º. console)");
        }
      };

      // —á—Ç–æ–±—ã –Ω–µ –Ω–∞–≤–µ—Å–∏—Ç—å 100 –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏—è—Ö
      const once = (el, evt, fn) => {
        if (!el) return;
        const key = `__bound_${evt}`;
        if (el[key]) return;
        el.addEventListener(evt, fn);
        el[key] = true;
      };

      once(reloadBtn, "click", async () => { await load(); });

      once(saveBtn, "click", async () => {
        try {
          setStatus("üíæ –°–æ—Ö—Ä–∞–Ω—è—é...");
          await apiSavePlot(plotKey, {
            fio: fioEl ? fioEl.value.trim() : null,
            phone: phoneEl ? phoneEl.value.trim() : null,
            note: noteEl ? noteEl.value.trim() : null
          });
          await load();
        } catch (e) {
          console.error(e);
          setStatus("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Å–º. console)");
        }
      });

      await load();
    });

    // –∫–ª–∏–∫–∏
    layer.on("click", () => {
      console.log("CLICK, plot_key =", plotKey, "card_final =", rawCard);
      layer.openPopup();
    });

    // –ø–æ–¥–ø–∏—Å—å –Ω–æ–º–µ—Ä–∞ —É—á–∞—Å—Ç–∫–∞
    const num = extractPlotNumberFromCard(rawCard);
    if (num && layer.getBounds && layer.getBounds().isValid()) {
      layer.bindTooltip(num, {
        permanent: true,
        direction: "center",
        className: "parcel-label"
      });
    }
  }

  fetch(`Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
    .then(async (data) => {

      const baseLayer = L.geoJSON(data, {
        interactive: false,
        style: { color: "#ff0000", weight: 1, opacity: 0.35, fill: false }
      }).addTo(map);

      const parcelsLayer = L.geoJSON(data, {
        filter: isLandParcel, // ‚úÖ —Ñ–∏–ª—å—Ç—Ä –∑–¥–∞–Ω–∏–π
        interactive: true,
        bubblingMouseEvents: false,
        style: { color: "#ff0000", weight: 2, fillOpacity: 0.20 },
        onEachFeature: (feature, layer) => { bindPopupLogic(layer, feature); }
      }).addTo(map);

      parcelsLayer.bringToFront();

      const focusBounds = parcelsLayer.getBounds().isValid() ? parcelsLayer.getBounds() : baseLayer.getBounds();
      if (focusBounds && focusBounds.isValid()) {
        map.fitBounds(focusBounds, { padding: [20, 20] });
      }

      const ButtonsControl = L.Control.extend({
        options: { position: "bottomleft" },
        onAdd: function () {
          const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

          const btnZoomIn = L.DomUtil.create("button", "", container);
          btnZoomIn.innerText = "‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å";
          const btnZoomOut = L.DomUtil.create("button", "", container);
          btnZoomOut.innerText = "‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å";
          const btnFocus = L.DomUtil.create("button", "", container);
          btnFocus.innerText = "üîç –ö —É—á–∞—Å—Ç–∫–∞–º";
          const btnOverview = L.DomUtil.create("button", "", container);
          btnOverview.innerText = "üåç –û–±–∑–æ—Ä";

          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.on(btnZoomIn, "click", () => map.flyTo(map.getCenter(), map.getZoom() + 2, { duration: 0.4 }));
          L.DomEvent.on(btnZoomOut, "click", () => map.flyTo(map.getCenter(), map.getZoom() - 2, { duration: 0.4 }));
          L.DomEvent.on(btnFocus, "click", () => map.fitBounds(focusBounds, { padding: [20, 20], maxZoom: 18 }));
          L.DomEvent.on(btnOverview, "click", () => map.fitBounds(focusBounds, { padding: [100, 100] }));

          return container;
        }
      });

      map.addControl(new ButtonsControl());
    })
    .catch(err => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:", err);
      alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ —Ç–æ–∫–µ–Ω.");
    });

})();
</script>
</body>
</html>
