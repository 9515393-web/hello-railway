<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .leaflet-popup-content-wrapper { border-radius: 14px; }
    .leaflet-popup-content{
      width: 420px !important;
      max-width: 420px !important;
      max-height: 60vh;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.4;
    }

    .popup-raw { margin-bottom: 12px; }

    .edit-box{
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }

    .edit-row{ margin: 8px 0; }

    .edit-row label{
      display:block;
      font-size: 13px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .edit-row input, .edit-row textarea{
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .edit-actions{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }

    .btn{
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-save{ background: #1f7ae0; color: #fff; }
    .btn-reload{ background: #eee; }

    .status-line{
      margin-top: 8px;
      font-size: 12px;
      opacity: .75;
    }

    .parcel-label{
      background:transparent !important;
      border:none !important;
      box-shadow:none !important;
      color:#111 !important;
      font-weight:700 !important;
      font-size:12px !important;
      text-shadow:0 0 2px #fff;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
(function () {

  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");
  if (!token) { alert("‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞"); throw new Error("No token"); }

  const map = L.map("map", { zoomControl: false });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function cardFinalToHtml(rawCard) {
    return escapeHtml(rawCard).replace(/\n/g, "<br>");
  }

  function getPlotKey(feature) {
    const uch = String(feature?.properties?.uch_num || "").trim();
    const card = String(feature?.properties?.card_final || "");
    const m = card.match(/–ó–∞—Ö–æ–∂—å–µ\s*[-‚Äì‚Äî]?\s*(2|3|4|5|6)\b/i);
    const snt = m ? m[1] : "0";
    return `${snt}-${uch || "?"}`;
  }

  async function apiGetPlot(plotKey) {
    const r = await fetch(`/api/plot/${encodeURIComponent(plotKey)}?token=${encodeURIComponent(token)}`);
    if (!r.ok) throw new Error("GET failed");
    return await r.json();
  }

  async function apiSavePlot(plotKey, payload) {
    const r = await fetch(`/api/plot/${encodeURIComponent(plotKey)}?token=${encodeURIComponent(token)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error("POST failed");
    return await r.json();
  }

  function renderPopupHtml(rawCard, plotKey) {
    return `
      <div>
        <div class="popup-raw">${cardFinalToHtml(rawCard)}</div>

        <div class="edit-box">
          <div style="font-weight:700;margin-bottom:6px;">‚úçÔ∏è –î–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</div>

          <div class="edit-row">
            <label>–§.–ò.–û.</label>
            <input id="fio-${plotKey}" type="text">
          </div>

          <div class="edit-row">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="phone-${plotKey}" type="text">
          </div>

          <div class="edit-row">
            <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
            <textarea id="note-${plotKey}" rows="3"></textarea>
          </div>

          <div class="edit-actions">
            <button class="btn btn-reload" id="reload-${plotKey}">‚ôªÔ∏è –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn btn-save" id="save-${plotKey}">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>

          <div class="status-line" id="status-${plotKey}">plot_key: ${escapeHtml(plotKey)}</div>
        </div>
      </div>
    `;
  }

  function bindPopupLogic(layer, feature) {
    const rawCard = String(feature?.properties?.card_final || "").trim();
    const plotKey = getPlotKey(feature);

    layer.bindPopup(renderPopupHtml(rawCard, plotKey), { maxWidth: 9999 });

    layer.on("popupopen", async (e) => {

      const container = e.popup.getElement();
      if (!container) return;

      const fioEl = container.querySelector('[id="fio-' + plotKey + '"]');
      const phoneEl = container.querySelector('[id="phone-' + plotKey + '"]');
      const noteEl = container.querySelector('[id="note-' + plotKey + '"]');
      const statusEl = container.querySelector('[id="status-' + plotKey + '"]');
      const saveBtn = container.querySelector('[id="save-' + plotKey + '"]');
      const reloadBtn = container.querySelector('[id="reload-' + plotKey + '"]');

      const setStatus = (t) => { if (statusEl) statusEl.textContent = t; };

      async function load() {
        try {
          setStatus("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...");
          const data = await apiGetPlot(plotKey);
          if (fioEl) fioEl.value = data?.fio ?? "";
          if (phoneEl) phoneEl.value = data?.phone ?? "";
          if (noteEl) noteEl.value = data?.note ?? "";
          setStatus("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ");
        } catch (e) {
          console.error(e);
          setStatus("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
        }
      }

      if (reloadBtn && !reloadBtn._bound) {
        reloadBtn.addEventListener("click", load);
        reloadBtn._bound = true;
      }

      if (saveBtn && !saveBtn._bound) {
        saveBtn.addEventListener("click", async () => {
          try {
            setStatus("üíæ –°–æ—Ö—Ä–∞–Ω—è—é...");
            await apiSavePlot(plotKey, {
              fio: fioEl?.value.trim() || null,
              phone: phoneEl?.value.trim() || null,
              note: noteEl?.value.trim() || null
            });
            setStatus("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
          } catch (e) {
            console.error(e);
            setStatus("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
          }
        });
        saveBtn._bound = true;
      }

      await load();
    });

    layer.on("click", () => layer.openPopup());
  }

  fetch(`Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => r.json())
    .then(data => {
      const parcelsLayer = L.geoJSON(data, {
        style: { color: "#ff0000", weight: 2, fillOpacity: 0.2 },
        onEachFeature: bindPopupLogic
      }).addTo(map);

      map.fitBounds(parcelsLayer.getBounds(), { padding: [20, 20] });
    });

})();
</script>
</body>
</html>
