<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  .parcel-label{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  color: #111 !important;
  font-weight: 700 !important;
  font-size: 12px !important;
  text-shadow: 0 0 2px #fff, 0 0 2px #fff;
}

.leaflet-control.custom-buttons{
  background: rgba(255,255,255,0.9);
  pointer-events: auto;
  z-index: 1000;
}
.leaflet-control.custom-buttons button{
  pointer-events: auto;
  cursor: pointer;
}

  <style>
html, body, #map {
  height: 100%;
  margin: 0;
}

/* =========================
   POPUP ‚Äî –ë–ê–ó–û–í–´–ô (–ü–ö)
========================= */
.leaflet-popup-content-wrapper {
  border-radius: 14px;
}

.leaflet-popup-content {
  width: 420px !important;
  max-width: 420px !important;
  max-height: 60vh;
  overflow-y: auto;

  font-size: 16px;
  line-height: 1.4;

  white-space: normal !important;
  word-break: normal;
  overflow-wrap: break-word;
}

/* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ø–∞–ø–∞ */
.popup-root {
  font-size: 16px;
  line-height: 1.4;
}

.popup-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

/* =========================
   –ö–ù–û–ü–ö–ò ‚Äî –ë–ê–ó–û–í–´–ï (–ü–ö)
========================= */
.leaflet-control.custom-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 12px;
  border-radius: 16px;
}

.leaflet-control.custom-buttons button {
  min-height: 48px;
  padding: 10px 14px;
  font-size: 16px;
  border-radius: 12px;
}

/* =========================
   üì± –¢–ï–õ–ï–§–û–ù
   –ü–æ–ø–∞–ø: —É–º–µ–Ω—å—à–∞–µ–º ~–≤ 0.5 —Ä–∞–∑–∞
   –ö–Ω–æ–ø–∫–∏: —É–º–µ–Ω—å—à–∞–µ–º ~–≤ 3 —Ä–∞–∑–∞
========================= */
@media (max-width: 768px) {

  /* ===== POPUP ===== */
  .leaflet-popup-content {
    width: 90vw !important;
    max-width: 90vw !important;
    max-height: 60vh !important;
    font-size: 12px !important;
    line-height: 1.3 !important;
    padding: 10px !important;
  }

  .popup-root { font-size: 12px !important; }
  .popup-title { font-size: 14px !important; }
  .leaflet-popup-close-button { font-size: 20px !important; }

  /* ===== –ö–ù–û–ü–ö–ò ===== */
  .leaflet-bottom.leaflet-left .leaflet-control.custom-buttons {
    margin: 10px !important;
  }

  .leaflet-control.custom-buttons {
    gap: 6px !important;
    padding: 6px !important;
    border-radius: 10px !important;
  }

  .leaflet-control.custom-buttons button {
    width: auto !important;
    min-height: 32px !important;
    padding: 6px 10px !important;
    font-size: 12px !important;
    border-radius: 8px !important;
  }
}

/* –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞ */

</style>

</head>
<body>
<div id="map"></div>

<script>
console.log("MAP SCRIPT LOADED");

(function () {
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    alert("‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞");
    throw new Error("No token");
  }

  const map = L.map("map", { zoomControl: false });
  setTimeout(() => {
    map.invalidateSize(true);
  }, 0);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  fetch(`Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(data => {
      let selected = null;


// ===== 1) –ü–æ–¥–ª–æ–∂–∫–∞: –≤—Å–µ –≥—Ä–∞–Ω–∏—Ü—ã (–ö–ü–¢ + —É—á–∞—Å—Ç–∫–∏ –±–µ–∑ –Ω–æ–º–µ—Ä–∞ + –ø—Ä–æ—á–µ–µ) =====
const baseLayer = L.geoJSON(data, {
  interactive: false,
  style: { color: "#ff0000", weight: 1, opacity: 0.35, fill: false }
}).addTo(map);

// ===== 2) –ù–æ–º–µ—Ä–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ (uch_num –Ω–µ –ø—É—Å—Ç–æ–π) =====
const parcelsLayer = L.geoJSON(data, {
  filter: f => String(f?.properties?.uch_num || "").trim() !== "",
  style: { color: "#ff0000", weight: 2, fillOpacity: 0.20 },
  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};
    const uch = String(p.uch_num || "").trim();

    // POPUP: —Ç–æ–ª—å–∫–æ –∏–∑ card_final (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
    const body = String(p.card_final || "").trim();
    const html = `
      <div class="popup-root">
        <div class="popup-title">–£—á–∞—Å—Ç–æ–∫ ‚Ññ ${uch}</div>
        <div>${body || ""}</div>
      </div>
    `;
    layer.bindPopup(html, { maxWidth: 9999, autoPan: true });

    // –ù–æ–º–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
    layer.bindTooltip(uch, {
      permanent: true,
      direction: "center",
      className: "parcel-label"
    });

    layer.on("click", () => {
      if (selected && selected !== layer) {
        selected.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.20 });
      }
      selected = layer;
      layer.setStyle({ color: "#ffff00", weight: 5, fillOpacity: 0.45 });
      layer.openPopup();
    });
  }
}).addTo(map);


// ===== 3) –ì—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ñ–æ–∫—É—Å–∞/–∫–Ω–æ–ø–æ–∫ =====
const parcelsBounds = parcelsLayer.getBounds();
const baseBounds = baseLayer.getBounds();
const focusBounds = (parcelsBounds && parcelsBounds.isValid()) ? parcelsBounds : baseBounds;

if (!focusBounds || !focusBounds.isValid()) {
  alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã");
  return;
}

// –°—Ç–∞—Ä—Ç–æ–≤—ã–π —Ñ–æ–∫—É—Å
map.fitBounds(focusBounds, { padding: [20, 20] });



      // –ö–Ω–æ–ø–∫–∏
      const ButtonsControl = L.Control.extend({
        options: { position: "bottomleft" },
        onAdd: function () {
          const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

          const btnZoomIn = L.DomUtil.create("button", "", container);
          btnZoomIn.type = "button";
          btnZoomIn.innerText = "‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å";

          const btnZoomOut = L.DomUtil.create("button", "", container);
          btnZoomOut.type = "button";
          btnZoomOut.innerText = "‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å";

          const btnFocus = L.DomUtil.create("button", "", container);
          btnFocus.type = "button";
          btnFocus.innerText = "üîç –ö —É—á–∞—Å—Ç–∫–∞–º";

          const btnOverview = L.DomUtil.create("button", "", container);
          btnOverview.type = "button";
          btnOverview.innerText = "üåç –û–±–∑–æ—Ä";


          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);

          function bind(btn, handler) {
            L.DomEvent.on(btn, "click", function (e) {
              L.DomEvent.stop(e);
              handler();
            });
          }

          bind(btnZoomIn, () => map.flyTo(map.getCenter(), map.getZoom() + 2, { duration: 0.4 }));
          bind(btnZoomOut, () => map.flyTo(map.getCenter(), map.getZoom() - 2, { duration: 0.4 }));

         bind(btnFocus, () => {
           map.invalidateSize(true);
           map.fitBounds(focusBounds, { padding: [20, 20], maxZoom: 18 });
         });

         bind(btnOverview, () => {
           map.invalidateSize(true);
           map.fitBounds(focusBounds, { padding: [100, 100] });
         });


          return container;
        }
      });

      map.addControl(new ButtonsControl());
    })
    .catch(err => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:", err);
      alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ —Ç–æ–∫–µ–Ω.");
    });
})();
</script>


</body>
</html>
