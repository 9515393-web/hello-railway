<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Админ-карта Захожье</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
html, body, #map { height: 100%; margin: 0; }

/* POPUP */
.leaflet-popup-content-wrapper { border-radius: 14px; }
.leaflet-popup-content {
  width: 420px !important;
  max-width: 420px !important;
  max-height: 60vh;
  overflow-y: auto;
  font-size: 16px;
  line-height: 1.4;
  white-space: normal !important;
  word-break: normal;
  overflow-wrap: break-word;
}
.popup-root { font-size: 16px; line-height: 1.4; }
.popup-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }

/* BUTTONS */
.leaflet-control.custom-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 12px;
  border-radius: 16px;
  background: rgba(255,255,255,0.9);
  pointer-events: auto;
  z-index: 1000;
}
.leaflet-control.custom-buttons button {
  min-height: 48px;
  padding: 10px 14px;
  font-size: 16px;
  border-radius: 12px;
  pointer-events: auto;
  cursor: pointer;
}

/* LABELS */
.parcel-label{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  color: #111 !important;
  font-weight: 700 !important;
  font-size: 12px !important;
  text-shadow: 0 0 2px #fff, 0 0 2px #fff;
}
</style>
</head>
<body>
<div id="map"></div>

<script>
console.log("MAP SCRIPT LOADED");
console.log("SCRIPT VERSION CLEAN CARD_FINAL ONLY");

(function () {
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");
  if (!token) { alert("⛔ Нет токена доступа"); throw new Error("No token"); }

  const map = L.map("map", { zoomControl: false });
  setTimeout(() => map.invalidateSize(true), 0);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap"
  }).addTo(map);

  fetch(`Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
    .then(data => {
      let selected = null;

      // 1) Подложка: все границы — КРАСНЫЕ
      const baseLayer = L.geoJSON(data, {
        interactive: false,
        style: { color: "#ff0000", weight: 1, opacity: 0.35, fill: false }
      }).addTo(map);

      // Функция: вытаскиваем номер ТОЛЬКО из card_final
      function extractNumberFromCard(card) {
        if (!card) return "";
        const raw = String(card);
        const m = raw.match(/(?:уч\.?|участок|№)\s*№?\s*(\d+)/i);
        return m && m[1] ? m[1] : "";
      }

      // 2) Слой участков (карточка ТОЛЬКО из card_final)
      const parcelsLayer = L.geoJSON(data, {
        style: { color: "#ff0000", weight: 2, fillOpacity: 0.20 },
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};

          // Карточка — ТОЛЬКО card_final
          const rawBody = String(p.card_final || "").trim();
          const bodyHtml = rawBody.replace(/\n/g, "<br>");

          const html = `
            <div class="popup-root">
              <div>${bodyHtml}</div>
            </div>
          `;
          layer.bindPopup(html, { maxWidth: 9999, autoPan: true });

          // Номер на плане — ИЩЕМ ТОЛЬКО В card_final
          const num = extractNumberFromCard(rawBody);

          // Подписываем ТОЛЬКО если номер реально найден в card_final
          if (num) {
            try {
              if (layer.getBounds && layer.getBounds().isValid()) {
                layer.bindTooltip(num, {
                  permanent: true,
                  direction: "center",
                  className: "parcel-label"
                });
              }
            } catch (e) {
              console.warn("Не удалось поставить подпись для участка:", num);
            }
          }

          // Подсветка при клике
          layer.on("click", () => {
            if (selected && selected !== layer) {
              selected.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.20 });
            }
            selected = layer;
            layer.setStyle({ color: "#ffff00", weight: 5, fillOpacity: 0.45 });
            layer.openPopup();
          });
        }
      }).addTo(map);

      // Фокус
      const parcelsBounds = parcelsLayer.getBounds();
      const baseBounds = baseLayer.getBounds();
      const focusBounds = (parcelsBounds && parcelsBounds.isValid()) ? parcelsBounds : baseBounds;

      if (!focusBounds || !focusBounds.isValid()) {
        alert("❌ Не удалось определить границы");
        return;
      }

      map.fitBounds(focusBounds, { padding: [20, 20] });

      // Кнопки
      const ButtonsControl = L.Control.extend({
        options: { position: "bottomleft" },
        onAdd: function () {
          const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

          const btnZoomIn = L.DomUtil.create("button", "", container);
          btnZoomIn.type = "button";
          btnZoomIn.innerText = "➕ Приблизить";

          const btnZoomOut = L.DomUtil.create("button", "", container);
          btnZoomOut.type = "button";
          btnZoomOut.innerText = "➖ Отдалить";

          const btnFocus = L.DomUtil.create("button", "", container);
          btnFocus.type = "button";
          btn
