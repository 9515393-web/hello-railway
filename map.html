<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Админ-карта Захожье</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }

    /* POPUP аккуратный */
    .leaflet-popup-content-wrapper { border-radius: 14px; }

    .leaflet-popup-content {
      max-width: 420px !important;
      max-height: 40vh;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.35;
      white-space: normal !important;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    @media (max-width: 600px) {
      .leaflet-popup-content {
        max-width: 92vw !important;
        max-height: 35vh;
      }
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    document.body.innerHTML = "⛔ Нет токена доступа";
    throw new Error("No token");
  }

  const map = L.map("map", { zoomControl: true });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap"
  }).addTo(map);

  fetch(`/Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => {
      if (!r.ok) throw new Error("Forbidden or not found");
      return r.json();
    })
    .then(data => {
      let selected = null;

      function isParcel(f) {
        const cn = f?.properties?.cn;
        if (!cn) return false;
        const parts = String(cn).split(":");
        return parts.length >= 4 && parts[3] && parts[3].length > 0;
      }

      const parcels = L.geoJSON(data, {
        filter: f => isParcel(f),
        style: {
          color: "#ff0000",
          weight: 2,
          fillOpacity: 0.2
        },

        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};

          const cn   = p.cn || "—";
          const area = p.area || "—";
          const cost = p.cost || "—";
          const type = p.type || "—";
          const fio  = p.fio || "—";
          const addr = p.phone || "—";

          const html = `
            <div>
              <div style="font-weight:700; font-size:18px; margin-bottom:6px;">
                Земельный участок
              </div>
              <table style="width:100%; border-collapse: collapse;">
                <tr><td>Кадастровый номер</td><td><b>${cn}</b></td></tr>
                <tr><td>Адрес</td><td>${addr}</td></tr>
                <tr><td>Площадь</td><td>${area} м²</td></tr>
                <tr><td>Стоимость</td><td><b>${cost}</b> ₽</td></tr>
                <tr><td>Тип</td><td>${type}</td></tr>
                <tr><td>ФИО</td><td>${fio}</td></tr>
              </table>
            </div>
          `;

          layer.bindPopup(html, { maxWidth: 420 });

          layer.on("click", () => {
            if (selected && selected !== layer) {
              selected.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.2 });
            }
            selected = layer;
            layer.setStyle({ color: "#ffff00", weight: 4, fillOpacity: 0.35 });
            layer.openPopup();
          });
        }
      }).addTo(map);

      const bounds = L.latLngBounds([]);
      parcels.eachLayer(l => {
        if (l.getBounds) bounds.extend(l.getBounds());
      });

      if (bounds.isValid()) {
        map.fitBounds(bounds, { padding: [40, 40] });
      }
    })
    .catch(err => {
      console.error(err);
      document.body.innerHTML = "⛔ Ошибка загрузки данных";
    });
</script>

</body>
</html>
