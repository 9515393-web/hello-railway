<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ê–¥–º–∏–Ω-–∫–∞—Ä—Ç–∞ –ó–∞—Ö–æ–∂—å–µ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
html, body, #map {
  height: 100%;
  margin: 0;
}

/* =========================
   POPUP ‚Äî –ë–ê–ó–û–í–´–ô (–ü–ö)
========================= */
.leaflet-popup-content-wrapper {
  border-radius: 14px;
}

.leaflet-popup-content {
  width: 420px !important;
  max-width: 420px !important;
  max-height: 60vh;
  overflow-y: auto;

  font-size: 16px;
  line-height: 1.4;

  white-space: normal !important;
  word-break: normal;
  overflow-wrap: break-word;
}

/* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ø–∞–ø–∞ */
.popup-root {
  font-size: 16px;
  line-height: 1.4;
}

.popup-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

/* =========================
   –ö–ù–û–ü–ö–ò ‚Äî –ë–ê–ó–û–í–´–ï (–ü–ö)
========================= */
.leaflet-control.custom-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 12px;
  border-radius: 16px;
}

.leaflet-control.custom-buttons button {
  min-height: 48px;
  padding: 10px 14px;
  font-size: 16px;
  border-radius: 12px;
}

/* =========================
   üì± –¢–ï–õ–ï–§–û–ù
   –ü–æ–ø–∞–ø: —É–º–µ–Ω—å—à–∞–µ–º ~–≤ 0.5 —Ä–∞–∑–∞
   –ö–Ω–æ–ø–∫–∏: —É–º–µ–Ω—å—à–∞–µ–º ~–≤ 3 —Ä–∞–∑–∞
========================= */
@media (max-width: 768px) {

  /* ===== POPUP ===== */
  .leaflet-popup-content {
    width: 90vw !important;
    max-width: 90vw !important;
    max-height: 60vh !important;
    font-size: 12px !important;
    line-height: 1.3 !important;
    padding: 10px !important;
  }

  .popup-root { font-size: 12px !important; }
  .popup-title { font-size: 14px !important; }
  .leaflet-popup-close-button { font-size: 20px !important; }

  /* ===== –ö–ù–û–ü–ö–ò ===== */
  .leaflet-bottom.leaflet-left .leaflet-control.custom-buttons {
    margin: 10px !important;
  }

  .leaflet-control.custom-buttons {
    gap: 6px !important;
    padding: 6px !important;
    border-radius: 10px !important;
  }

  .leaflet-control.custom-buttons button {
    width: auto !important;
    min-height: 32px !important;
    padding: 6px 10px !important;
    font-size: 12px !important;
    border-radius: 8px !important;
  }
}

/* –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞ */
@media (max-width: 768px) {
  body { background: red !important; }
}
</style>

</head>
<body>
<div id="map"></div>

<script>
(function () {
  // ‚úÖ –ü–ª–∞—à–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "–ø—Ä–æ—Å—Ç–æ –±–µ–ª–æ")
  const status = document.createElement("div");
  status.style.cssText =
    "position:fixed;z-index:9999;left:10px;top:10px;padding:8px 10px;" +
    "background:rgba(0,0,0,.75);color:#fff;font:14px/1.3 Arial;border-radius:8px;max-width:90vw";
  status.textContent = "init...";
  document.body.appendChild(status);

  // ‚úÖ –õ—é–±–∞—è –æ—à–∏–±–∫–∞ JS ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  window.onerror = function (msg, url, line, col) {
    status.textContent = "JS ERROR: " + msg + " @ " + line + ":" + col;
  };

  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    status.textContent = "‚õî –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞";
    return;
  }

  let focusCenter = L.latLng(59.9, 30.3);
  status.textContent = "Leaflet map...";
  const map = L.map("map", { zoomControl: false });

  // ‚úÖ –°–†–ê–ó–£ –∑–∞–¥–∞—ë–º –≤–∏–¥, —á—Ç–æ–±—ã —Ç–∞–π–ª—ã –ø–æ–∫–∞–∑–∞–ª–∏—Å—å –¥–∞–∂–µ –µ—Å–ª–∏ fetch —É–ø–∞–¥—ë—Ç
  map.setView(focusCenter, 12);

  const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  tiles.on("tileerror", () => {
    status.textContent = "‚ùå –¢–∞–π–ª—ã –Ω–µ –≥—Ä—É–∑—è—Ç—Å—è (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞/CDN)";
  });

  status.textContent = "fetch geojson...";

  fetch(`/Zahozhe_final_2026.geojson?token=${encodeURIComponent(token)}`)
    .then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(data => {
      status.textContent = "geojson loaded, rendering...";

      let selected = null;

      function isRealParcel(feature) {
        const cn = feature?.properties?.cn;
        if (!cn) return false;
        const parts = String(cn).split(":");
        return parts.length === 4 && parts[3] && parts[3].length > 0;
      }

      // –ö–≤–∞—Ä—Ç–∞–ª—ã
      L.geoJSON(data, {
        filter: f => {
          const cn = f?.properties?.cn;
          if (!cn) return false;
          return String(cn).split(":").length === 3;
        },
        style: { color: "#ff0000", weight: 2, fill: false }
      }).addTo(map);

      // –£—á–∞—Å—Ç–∫–∏
      const parcelsLayer = L.geoJSON(data, {
        filter: f => isRealParcel(f),
        style: { color: "#ff0000", weight: 2, fillOpacity: 0.20 },

        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          const html = `
            <div class="popup-root">
              <div class="popup-title">–ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫</div>
              <table style="width:100%; border-collapse:collapse;">
                <tr><td>–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π ‚Ññ</td><td><b>${p.cn || "‚Äî"}</b></td></tr>
                <tr><td>–ê–¥—Ä–µ—Å</td><td>${p.address || p.addr || p.location || "‚Äî"}</td></tr>
                <tr><td>–ü–ª–æ—â–∞–¥—å</td><td>${p.area || "‚Äî"} –º¬≤</td></tr>
                <tr><td>–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</td><td><b>${p.cost || "‚Äî"}</b></td></tr>
                <tr><td>–¢–∏–ø</td><td>${p.type || "‚Äî"}</td></tr>
              </table>
            </div>
          `;

          layer.bindPopup(html, { maxWidth: 9999, autoPan: true });

          layer.on("click", () => {
            if (selected && selected !== layer) {
              selected.setStyle({ color: "#ff0000", weight: 2, fillOpacity: 0.20 });
            }
            selected = layer;
            layer.setStyle({ color: "#ffff00", weight: 5, fillOpacity: 0.45 });
            layer.openPopup();

            if (layer.getBounds && layer.getBounds().isValid()) {
              focusCenter = layer.getBounds().getCenter();
            }
          });
        }
      }).addTo(map);

      // ‚úÖ –¶–µ–Ω—Ç—Ä –ø–æ —É—á–∞—Å—Ç–∫–∞–º (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è parcelsLayer)
      const centers = [];
      parcelsLayer.eachLayer(l => {
        if (l.getBounds && l.getBounds().isValid()) centers.push(l.getBounds().getCenter());
      });

      if (centers.length) {
        const lats = centers.map(c => c.lat).sort((a,b)=>a-b);
        const lngs = centers.map(c => c.lng).sort((a,b)=>a-b);
        focusCenter = L.latLng(lats[Math.floor(lats.length/2)], lngs[Math.floor(lngs.length/2)]);
        map.setView(focusCenter, 17);
      }

      // –ö–Ω–æ–ø–∫–∏
      const ButtonsControl = L.Control.extend({
        options: { position: "bottomleft" },
        onAdd: function () {
          const container = L.DomUtil.create("div", "leaflet-control custom-buttons");

          const btnZoomIn = L.DomUtil.create("button", "", container);
          btnZoomIn.innerText = "‚ûï –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å";

          const btnZoomOut = L.DomUtil.create("button", "", container);
          btnZoomOut.innerText = "‚ûñ –û—Ç–¥–∞–ª–∏—Ç—å";

          const btnFocus = L.DomUtil.create("button", "", container);
          btnFocus.innerText = "üîç –ö —É—á–∞—Å—Ç–∫–∞–º";

          const btnOverview = L.DomUtil.create("button", "", container);
          btnOverview.innerText = "üåç –û–±–∑–æ—Ä";

          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);

          btnZoomIn.onclick = () => map.flyTo(map.getCenter(), map.getZoom() + 2, { duration: 0.4 });
          btnZoomOut.onclick = () => map.flyTo(map.getCenter(), map.getZoom() - 2, { duration: 0.4 });
          btnFocus.onclick = () => map.flyTo(focusCenter, 18, { animate: true, duration: 0.5 });
          btnOverview.onclick = () => map.flyTo(focusCenter, 14, { animate: true, duration: 0.5 });

          return container;
        }
      });
      map.addControl(new ButtonsControl());

      status.textContent = "‚úÖ ready";
      setTimeout(() => status.remove(), 1500);
    })
    .catch(err => {
      status.textContent = "‚ùå fetch/parse error: " + (err && err.message ? err.message : String(err));
    });
})();
</script>


</body>
</html>
